<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">// Generated by CoffeeScript 1.6.3
/*
Copyright (c) 2012-2013 [DeftJS Framework Contributors](http://deftjs.org)
Open source under the [MIT License](http://en.wikipedia.org/wiki/MIT_License).
*/

<span id='Deft-mvc-ViewController'>/**
</span>A lightweight MVC view controller. Full usage instructions in the [DeftJS documentation](https://github.com/deftjs/DeftJS/wiki/ViewController).

First, specify a ViewController to attach to a view:

    Ext.define(&quot;DeftQuickStart.view.MyTabPanel&quot;, {
      extend: &quot;Ext.tab.Panel&quot;,
      controller: &quot;DeftQuickStart.controller.MainController&quot;,
      ...
    });

Next, define the ViewController:

    Ext.define(&quot;DeftQuickStart.controller.MainController&quot;, {
      extend: &quot;Deft.mvc.ViewController&quot;,

      init: function() {
        return this.callParent(arguments);
      }

    });

## Inject dependencies using the &lt;u&gt;[`inject` property](https://github.com/deftjs/DeftJS/wiki/Injecting-Dependencies)&lt;/u&gt;:

    Ext.define(&quot;DeftQuickStart.controller.MainController&quot;, {
      extend: &quot;Deft.mvc.ViewController&quot;,
      inject: [&quot;companyStore&quot;],

      config: {
        companyStore: null
      },

      init: function() {
        return this.callParent(arguments);
      }

    });

## Define &lt;u&gt;[references to view components](https://github.com/deftjs/DeftJS/wiki/Accessing-Views)&lt;/u&gt; and &lt;u&gt;[add view listeners](https://github.com/deftjs/DeftJS/wiki/Handling-View-Events)&lt;/u&gt; with the `control` property:

    Ext.define(&quot;DeftQuickStart.controller.MainController&quot;, {
      extend: &quot;Deft.mvc.ViewController&quot;,

      control: {

        // Most common configuration, using an itemId and listener
        manufacturingFilter: {
          change: &quot;onFilterChange&quot;
        },

        // Reference only, with no listeners
        serviceIndustryFilter: true,

        // Configuration using selector, listeners, and event listener options
        salesFilter: {
          selector: &quot;toolbar &gt; checkbox&quot;,
          listeners: {
            change: {
              fn: &quot;onFilterChange&quot;,
              buffer: 50,
              single: true
            }
          }
        }
      },

      init: function() {
        return this.callParent(arguments);
      }

      // Event handlers or other methods here...

    });

## Dynamically monitor view to attach listeners to added components with &lt;u&gt;[live selectors](https://github.com/deftjs/DeftJS/wiki/ViewController-Live-Selectors)&lt;/u&gt;:

    control: {
      manufacturingFilter: {
        live: true,
        listeners: {
          change: &quot;onFilterChange&quot;
        }
      }
    };

## Observe events on injected objects with the &lt;u&gt;[`observe` property](https://github.com/deftjs/DeftJS/wiki/ViewController-Observe-Configuration)&lt;/u&gt;:

    Ext.define(&quot;DeftQuickStart.controller.MainController&quot;, {
      extend: &quot;Deft.mvc.ViewController&quot;,
      inject: [&quot;companyStore&quot;],

      config: {
        companyStore: null
      },

      observe: {
        // Observe companyStore for the update event
        companyStore: {
          update: &quot;onCompanyStoreUpdateEvent&quot;
        }
      },

      init: function() {
        return this.callParent(arguments);
      },

      onCompanyStoreUpdateEvent: function(store, model, operation, fieldNames) {
        // Do something when store fires update event
      }

    });
*/

Ext.define('Deft.mvc.ViewController', {
  alternateClassName: ['Deft.ViewController'],
  requires: ['Deft.core.Class', 'Deft.log.Logger', 'Deft.mvc.ComponentSelector', 'Deft.mvc.Observer'],
  config: {
<span id='Deft-mvc-ViewController-cfg-view'>    /**
</span>    		* View controlled by this ViewController.
    */

    view: null
  },
<span id='Deft-mvc-ViewController-property-observe'>  /**
</span>  	* Observers automatically created and removed by this ViewController.
  */

  observe: {},
<span id='Deft-mvc-ViewController-property-control'>  /**
</span>  	* Controls automatically created and removed by this ViewController.
  */

  control: {},
<span id='Deft-mvc-ViewController-method-constructor'>  constructor: function(config) {
</span>    if (config == null) {
      config = {};
    }
    this.initConfig(config);
    this.registeredObservers = {};
    if (config.view) {
      this.controlView(config.view);
    }
    if (Ext.Object.getSize(this.observe) &gt; 0) {
      this.createObservers();
    }
    return this;
  },
<span id='Deft-mvc-ViewController-method-controlView'>  /**
</span>  	* @protected
  */

  controlView: function(view) {
    if (view instanceof Ext.ClassManager.get('Ext.Component')) {
      this.setView(view);
      this.registeredComponentReferences = {};
      this.registeredComponentSelectors = {};
      this.initComponentSelectors = {};
      this.observeComponentSelectors = {};
      this.initializeView();
    } else {
      Ext.Error.raise({
        msg: 'Error constructing ViewController: the configured \'view\' is not an Ext.Component.'
      });
    }
  },
<span id='Deft-mvc-ViewController-method-init'>  /**
</span>  	* Initialize the ViewController
  */

  init: function() {},
<span id='Deft-mvc-ViewController-method-destroy'>  /**
</span>  	* Destroy the ViewController
  */

  destroy: function() {
    var id, listener, selector, _ref;
    this.cleanupDefaultViewListeners();
    _ref = this.observeComponentSelectors;
    for (selector in _ref) {
      listener = _ref[selector];
      listener.destroy();
      delete this.observeComponentSelectors[selector];
    }
    for (id in this.registeredComponentReferences) {
      this.removeComponentReference(id);
    }
    for (selector in this.registeredComponentSelectors) {
      this.removeComponentSelector(selector);
    }
    this.removeObservers();
    return true;
  },
<span id='Deft-mvc-ViewController-property-S-control'>  /**
</span>  	* @private
  */

  $control: (function() {
    var config;
    if (Ext.getVersion('extjs')) {
      return config = {
        view: {
          beforedestroy: {
            fn: &quot;onViewBeforeDestroy&quot;
          },
          afterrender: {
            single: true,
            fn: &quot;onViewInitialize&quot;
          }
        }
      };
    } else {
      return config = {
        view: {
          initialize: {
            single: true,
            fn: &quot;onViewInitialize&quot;
          }
        }
      };
    }
  })(),
<span id='Deft-mvc-ViewController-method-setupDefaultViewListeners'>  /**
</span>  	* Sets up the default listeners for the controlled view.
  	* For ExtJS the listeners are for the beforedestroy and afterrender events
  	* For Sencha Touch initialize
  	* See $control above
  	* @private
  */

  setupDefaultViewListeners: function() {
    var componentSelector;
    componentSelector = Ext.create('Deft.mvc.ComponentSelector', {
      view: this.getView(),
      selector: null,
      listeners: this.$control.view,
      scope: this,
      live: true
    });
    this.initComponentSelectors[null] = componentSelector;
    if (!this.control.view) {
      this.control.view = {};
    }
  },
<span id='Deft-mvc-ViewController-method-cleanupDefaultViewListeners'>  /**
</span>  	* @private
  */

  cleanupDefaultViewListeners: function() {
    this.initComponentSelectors[null].destroy();
    delete this.initComponentSelectors[null];
  },
<span id='Deft-mvc-ViewController-method-onViewInitialize'>  /**
</span>  	* @private
  */

  onViewInitialize: function() {
    this.init();
  },
<span id='Deft-mvc-ViewController-method-createViewObservers'>  /**
</span>  	* @private
  */

  createViewObservers: function(view, eOpts) {
    view.$observers = {};
    return this.createObservers(eOpts.observe, view.$observers, view);
  },
<span id='Deft-mvc-ViewController-method-removeViewObservers'>  /**
</span>  	* @private
  */

  removeViewObservers: function(view) {
    return this.removeObservers(view.$observers);
  },
<span id='Deft-mvc-ViewController-method-addComponentObserver'>  /**
</span>  	* @private
  */

  addComponentObserver: function(selector, observe) {
    var componentSelector;
    if (Ext.getVersion('extjs')) {
      componentSelector = Ext.create('Deft.mvc.ComponentSelector', {
        view: this.getView(),
        selector: selector,
        listeners: {
          afterrender: {
            fn: 'createViewObservers',
            observe: observe
          },
          removed: {
            fn: 'removeViewObservers'
          }
        },
        scope: this,
        live: true
      });
    } else {
      componentSelector = Ext.create('Deft.mvc.ComponentSelector', {
        view: this.getView(),
        selector: selector,
        listeners: {
          initialize: {
            fn: 'createViewObservers',
            observe: observe
          },
          removed: {
            fn: 'removeViewObservers'
          }
        },
        scope: this,
        live: true
      });
    }
    return this.observeComponentSelectors[selector] = componentSelector;
  },
<span id='Deft-mvc-ViewController-method-initializeView'>  /**
</span>  	* @private
  */

  initializeView: function() {
    var config, element, elements, getterName, id, listeners, originalViewDestroyFunction, rendered, selector, self, _i, _len, _ref;
    rendered = this.getView().rendered || this.getView().initialized;
    this.setupDefaultViewListeners();
    _ref = this.control;
    for (id in _ref) {
      config = _ref[id];
      selector = null;
      if (id !== 'view') {
        if (Ext.isString(config)) {
          selector = config;
        } else if (config.selector != null) {
          selector = config.selector;
        } else {
          selector = '#' + id;
        }
      }
      listeners = null;
      if (Ext.isObject(config.listeners)) {
        listeners = config.listeners;
      } else {
        if (!((config.selector != null) || (config.live != null) || (config.observe != null))) {
          listeners = config;
        }
      }
      this.addComponentReference(id, selector);
      this.addComponentSelector(selector, listeners);
      if (Ext.isObject(config.observe)) {
        this.addComponentObserver(selector, config.observe);
      }
      if (rendered === true) {
        getterName = 'get' + Ext.String.capitalize(id);
        elements = this[getterName]();
        if (!Ext.isArray(elements)) {
          elements = [elements];
        }
        for (_i = 0, _len = elements.length; _i &lt; _len; _i++) {
          element = elements[_i];
          if (element !== null) {
            Deft.LiveEventBus.register(element, selector);
          }
        }
      }
    }
    if (Ext.getVersion('extjs') != null) {
      if (this.getView().rendered) {
        this.onViewInitialize();
      }
    } else {
      self = this;
      originalViewDestroyFunction = this.getView().destroy;
      this.getView().destroy = function() {
        if (self.destroy() !== false) {
          return originalViewDestroyFunction.call(this);
        }
        return false;
      };
      if (this.getView().initialized) {
        this.onViewInitialize();
      }
    }
  },
<span id='Deft-mvc-ViewController-method-onViewBeforeDestroy'>  /**
</span>  	* @private
  */

  onViewBeforeDestroy: function() {
    return this.destroy();
  },
<span id='Deft-mvc-ViewController-method-addComponentReference'>  /**
</span>  	* Add a component accessor method the ViewController for the specified view-relative selector.
  */

  addComponentReference: function(id, selector) {
    var getterName;
    if (this.registeredComponentReferences[id] != null) {
      Ext.Error.raise({
        msg: &quot;Error adding component reference: an existing component reference was already registered as '&quot; + id + &quot;'.&quot;
      });
    }
    if (id !== 'view') {
      getterName = 'get' + Ext.String.capitalize(id);
      if (this[getterName] == null) {
        Deft.Logger.log(&quot;Adding '&quot; + id + &quot;' component reference for selector: '&quot; + selector + &quot;'.&quot;);
        this[getterName] = Ext.Function.pass(this.getViewComponent, [selector], this);
        this[getterName].generated = true;
        this.registeredComponentReferences[id] = true;
      }
    }
  },
<span id='Deft-mvc-ViewController-method-removeComponentReference'>  /**
</span>  	* Remove a component accessor method the ViewController for the specified view-relative selector.
  */

  removeComponentReference: function(id) {
    var getterName;
    Deft.Logger.log(&quot;Removing '&quot; + id + &quot;' component reference.&quot;);
    if (this.registeredComponentReferences[id] == null) {
      Ext.Error.raise({
        msg: &quot;Error removing component reference: no component reference is registered as '&quot; + id + &quot;'.&quot;
      });
    }
    if (id !== 'view') {
      getterName = 'get' + Ext.String.capitalize(id);
      if (this[getterName].generated) {
        this[getterName] = null;
      }
    }
    delete this.registeredComponentReferences[id];
  },
<span id='Deft-mvc-ViewController-method-getViewComponent'>  /**
</span>  	* Get the component(s) corresponding to the specified view-relative selector.
  */

  getViewComponent: function(selector) {
    var matches;
    if (selector != null) {
      matches = Ext.ComponentQuery.query(selector, this.getView());
      if (matches.length === 0) {
        return null;
      } else if (matches.length === 1) {
        return matches[0];
      } else {
        return matches;
      }
    } else {
      return this.getView();
    }
  },
<span id='Deft-mvc-ViewController-method-addComponentSelector'>  /**
</span>  	* Add a component selector with the specified listeners for the specified view-relative selector.
  */

  addComponentSelector: function(selector, listeners) {
    var componentSelector, existingComponentSelector;
    Deft.Logger.log(&quot;Adding component selector for: '&quot; + (selector || 'view') + &quot;'.&quot;);
    existingComponentSelector = this.getComponentSelector(selector);
    if (existingComponentSelector != null) {
      Ext.Error.raise({
        msg: &quot;Error adding component selector: an existing component selector was already registered for '&quot; + selector + &quot;'.&quot;
      });
    }
    componentSelector = Ext.create('Deft.mvc.ComponentSelector', {
      view: this.getView(),
      selector: selector,
      listeners: listeners,
      scope: this,
      live: true
    });
    this.registeredComponentSelectors[selector] = componentSelector;
  },
<span id='Deft-mvc-ViewController-method-removeComponentSelector'>  /**
</span>  	* Remove a component selector with the specified listeners for the specified view-relative selector.
  */

  removeComponentSelector: function(selector) {
    var existingComponentSelector;
    Deft.Logger.log(&quot;Removing component selector for '&quot; + selector + &quot;'.&quot;);
    existingComponentSelector = this.getComponentSelector(selector);
    if (existingComponentSelector == null) {
      Ext.Error.raise({
        msg: &quot;Error removing component selector: no component selector registered for '&quot; + selector + &quot;'.&quot;
      });
    }
    existingComponentSelector.destroy();
    delete this.registeredComponentSelectors[selector];
  },
<span id='Deft-mvc-ViewController-method-getComponentSelector'>  /**
</span>  	* Get the component selector corresponding to the specified view-relative selector.
  */

  getComponentSelector: function(selector) {
    return this.registeredComponentSelectors[selector];
  },
<span id='Deft-mvc-ViewController-method-createObservers'>  /**
</span>  	* @protected
  */

  createObservers: function(observe, observerContainer, host) {
    var events, target;
    if (observe == null) {
      observe = this.observe;
    }
    if (observerContainer == null) {
      observerContainer = this.registeredObservers;
    }
    if (host == null) {
      host = this;
    }
    for (target in observe) {
      events = observe[target];
      this.addObserver(target, events, observerContainer, host);
    }
  },
<span id='Deft-mvc-ViewController-method-addObserver'>  addObserver: function(target, events, observerContainer, host) {
</span>    var observer;
    if (observerContainer == null) {
      observerContainer = this.registeredObservers;
    }
    if (host == null) {
      host = this;
    }
    observer = Ext.create('Deft.mvc.Observer', {
      host: host,
      target: target,
      events: events,
      scope: this
    });
    return observerContainer[target] = observer;
  },
<span id='Deft-mvc-ViewController-method-removeObservers'>  /**
</span>  	* @protected
  */

  removeObservers: function(observerContainer) {
    var observer, target;
    if (observerContainer == null) {
      observerContainer = this.registeredObservers;
    }
    for (target in observerContainer) {
      observer = observerContainer[target];
      observer.destroy();
      delete observerContainer[target];
    }
  }
}, function() {
<span id='Deft-mvc-ViewController-property-'>  /**
</span>  	* Preprocessor to handle merging of 'observe' objects on parent and child classes.
  */

  return Deft.Class.registerPreprocessor('observe', function(Class, data, hooks, callback) {
    Deft.Class.hookOnClassExtended(data, function(Class, data, hooks) {
      var _ref;
      if (Class.superclass &amp;&amp; ((_ref = Class.superclass) != null ? _ref.observe : void 0) &amp;&amp; Deft.Class.extendsClass(Class, 'Deft.mvc.ViewController')) {
        data.observe = Deft.mvc.Observer.mergeObserve(Class.superclass.observe, data.observe);
      }
    });
  }, 'before', 'extend');
});
</pre>
</body>
</html>
